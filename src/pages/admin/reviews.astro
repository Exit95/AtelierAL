---
import AdminLayout from "../../layouts/AdminLayout.astro";
import { getItems, type Review } from "../../lib/storage";

const reviews = await getItems<Review>("reviews");

// Count by status
const pendingCount = reviews.filter((r) => r.status === "pending").length;
const approvedCount = reviews.filter((r) => r.status === "approved").length;
const rejectedCount = reviews.filter((r) => r.status === "rejected").length;

// Sort by date (newest first)
const sortedReviews = reviews.sort(
    (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime(),
);
---

<AdminLayout title="Bewertungen verwalten">
    <div class="reviews-header">
        <h2>Kundenbewertungen</h2>
        <div class="stats">
            <div class="stat">
                <span class="stat-number pending">{pendingCount}</span>
                <span class="stat-label">Ausstehend</span>
            </div>
            <div class="stat">
                <span class="stat-number approved">{approvedCount}</span>
                <span class="stat-label">Genehmigt</span>
            </div>
            <div class="stat">
                <span class="stat-number rejected">{rejectedCount}</span>
                <span class="stat-label">Abgelehnt</span>
            </div>
        </div>
    </div>

    <div id="message" class="message"></div>

    {
        sortedReviews.length > 0 ? (
            <div class="reviews-list">
                {sortedReviews.map((review) => (
                    <div
                        class="review-item"
                        data-review-id={review.id}
                        data-status={review.status}
                    >
                        <div class="review-header-row">
                            <div class="review-meta">
                                <strong>{review.name}</strong>
                                {review.email && (
                                    <span class="email">({review.email})</span>
                                )}
                                <span class="date">
                                    {new Date(review.date).toLocaleDateString(
                                        "de-DE",
                                        {
                                            year: "numeric",
                                            month: "long",
                                            day: "numeric",
                                            hour: "2-digit",
                                            minute: "2-digit",
                                        },
                                    )}
                                </span>
                            </div>
                            <div class={`status-badge ${review.status}`}>
                                {review.status === "pending"
                                    ? "Ausstehend"
                                    : review.status === "approved"
                                      ? "Genehmigt"
                                      : "Abgelehnt"}
                            </div>
                        </div>

                        <div class="review-rating">
                            {Array.from({ length: review.rating }).map(() => (
                                <span class="star filled">★</span>
                            ))}
                            {Array.from({ length: 5 - review.rating }).map(
                                () => (
                                    <span class="star empty">★</span>
                                ),
                            )}
                        </div>

                        <p class="review-text">{review.text}</p>

                        <div class="review-actions">
                            {review.status !== "approved" && (
                                <button
                                    class="action-btn approve"
                                    data-action="approve"
                                    data-review-id={review.id}
                                >
                                    ✓ Genehmigen
                                </button>
                            )}
                            {review.status !== "rejected" && (
                                <button
                                    class="action-btn reject"
                                    data-action="reject"
                                    data-review-id={review.id}
                                >
                                    ✗ Ablehnen
                                </button>
                            )}
                        </div>
                    </div>
                ))}
            </div>
        ) : (
            <p class="no-reviews">Noch keine Bewertungen vorhanden.</p>
        )
    }
</AdminLayout>

<style>
    .reviews-header {
        margin-bottom: 2rem;
    }

    .reviews-header h2 {
        margin-bottom: 1rem;
    }

    .stats {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem 1.5rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .stat-number.pending {
        color: #f59e0b;
    }

    .stat-number.approved {
        color: #10b981;
    }

    .stat-number.rejected {
        color: #ef4444;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #666;
    }

    .message {
        display: none;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .message.success {
        display: block;
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
    }

    .message.error {
        display: block;
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
    }

    .reviews-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .review-item {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .review-header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .review-meta {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .review-meta strong {
        font-size: 1.125rem;
        color: #1a1a2e;
    }

    .email {
        font-size: 0.875rem;
        color: #666;
    }

    .date {
        font-size: 0.875rem;
        color: #999;
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .status-badge.pending {
        background-color: #fef3c7;
        color: #92400e;
    }

    .status-badge.approved {
        background-color: #d1fae5;
        color: #065f46;
    }

    .status-badge.rejected {
        background-color: #fee2e2;
        color: #991b1b;
    }

    .review-rating {
        display: flex;
        gap: 2px;
    }

    .star {
        font-size: 1.25rem;
    }

    .star.filled {
        color: #fbbf24;
    }

    .star.empty {
        color: #ddd;
    }

    .review-text {
        line-height: 1.6;
        color: #333;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
    }

    .review-actions {
        display: flex;
        gap: 0.75rem;
        padding-top: 0.5rem;
        border-top: 1px solid #e5e7eb;
    }

    .action-btn {
        padding: 0.625rem 1.25rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .action-btn.approve {
        background-color: #10b981;
        color: white;
    }

    .action-btn.approve:hover {
        background-color: #059669;
    }

    .action-btn.reject {
        background-color: #ef4444;
        color: white;
    }

    .action-btn.reject:hover {
        background-color: #dc2626;
    }

    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .no-reviews {
        text-align: center;
        color: #999;
        padding: 3rem;
        background: white;
        border-radius: 12px;
    }

    @media (max-width: 768px) {
        .review-header-row {
            flex-direction: column;
        }

        .review-actions {
            flex-direction: column;
        }

        .action-btn {
            width: 100%;
        }
    }
</style>

<script>
    const buttons = document.querySelectorAll(".action-btn");
    const messageEl = document.getElementById("message");

    buttons.forEach((button) => {
        button.addEventListener("click", async (e) => {
            const btn = e.currentTarget as HTMLButtonElement;
            const action = btn.dataset.action;
            const reviewId = btn.dataset.reviewId;

            if (!action || !reviewId) return;

            btn.disabled = true;

            try {
                const response = await fetch("/api/admin/reviews", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ reviewId, action }),
                });

                const result = await response.json();

                if (response.ok) {
                    if (messageEl) {
                        messageEl.className = "message success";
                        messageEl.textContent = `Bewertung erfolgreich ${action === "approve" ? "genehmigt" : "abgelehnt"}.`;
                    }
                    // Reload page to show updated status
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    if (messageEl) {
                        messageEl.className = "message error";
                        messageEl.textContent =
                            result.error || "Ein Fehler ist aufgetreten.";
                    }
                    btn.disabled = false;
                }
            } catch (error) {
                if (messageEl) {
                    messageEl.className = "message error";
                    messageEl.textContent =
                        "Verbindungsfehler. Bitte versuchen Sie es später erneut.";
                }
                btn.disabled = false;
            }
        });
    });
</script>
