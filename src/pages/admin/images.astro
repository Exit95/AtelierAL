---
import AdminLayout from "../../layouts/AdminLayout.astro";
---

<AdminLayout title="Bildverwaltung">
    <div class="images-manager">
        <div class="upload-section">
            <h2>Bild hochladen</h2>
            <form id="uploadForm" class="upload-form">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì§</div>
                    <p class="upload-text">Klicken oder Datei hierher ziehen</p>
                    <p class="upload-hint">Max. 100MB | JPG, PNG, GIF, WebP</p>
                    <input
                        type="file"
                        id="fileInput"
                        name="file"
                        accept="image/*"
                        hidden
                    />
                </div>
                <div id="uploadStatus" class="upload-status"></div>
            </form>
        </div>

        <div class="gallery-section">
            <h2>Hochgeladene Bilder</h2>
            <div id="gallery" class="gallery-grid">
                <div class="loading">Lade Bilder...</div>
            </div>
        </div>
    </div>
</AdminLayout>

<style>
    .images-manager {
        max-width: 1200px;
        margin: 0 auto;
    }

    .upload-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .upload-section h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #1a1a2e;
    }

    .upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 3rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }

    .upload-area:hover,
    .upload-area.drag-over {
        border-color: var(--color-brand-beige);
        background: #f9f9f9;
    }

    .upload-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .upload-text {
        font-size: 1.1rem;
        color: #333;
        margin: 0.5rem 0;
    }

    .upload-hint {
        color: #666;
        font-size: 0.9rem;
        margin: 0;
    }

    .upload-status {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 8px;
        display: none;
    }

    .upload-status.success {
        display: block;
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .upload-status.error {
        display: block;
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .upload-status.uploading {
        display: block;
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    .gallery-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .gallery-section h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #1a1a2e;
    }

    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .loading {
        text-align: center;
        color: #666;
        padding: 2rem;
    }

    .image-card {
        background: #f5f5f5;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }

    .image-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .image-preview {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #e0e0e0;
    }

    .image-info {
        padding: 1rem;
    }

    .image-name {
        font-size: 0.9rem;
        color: #333;
        margin: 0 0 0.5rem 0;
        word-break: break-all;
    }

    .image-meta {
        font-size: 0.8rem;
        color: #666;
        margin: 0.25rem 0;
    }

    .image-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
    }

    .btn-copy {
        background: var(--color-brand-beige);
        color: white;
        flex: 1;
    }

    .btn-copy:hover {
        background: var(--color-accent);
    }

    .btn-delete {
        background: #dc3545;
        color: white;
        padding: 0.5rem;
    }

    .btn-delete:hover {
        background: #c82333;
    }

    @media (max-width: 640px) {
        .gallery-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    const uploadArea = document.getElementById("uploadArea") as HTMLDivElement;
    const fileInput = document.getElementById("fileInput") as HTMLInputElement;
    const uploadForm = document.getElementById("uploadForm") as HTMLFormElement;
    const uploadStatus = document.getElementById(
        "uploadStatus",
    ) as HTMLDivElement;
    const gallery = document.getElementById("gallery") as HTMLDivElement;

    // Click to upload
    uploadArea.addEventListener("click", () => {
        fileInput.click();
    });

    // Drag and drop
    uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("drag-over");
    });

    uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("drag-over");
    });

    uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("drag-over");
        const files = e.dataTransfer?.files;
        if (files && files[0]) {
            uploadFile(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener("change", () => {
        if (fileInput.files && fileInput.files[0]) {
            uploadFile(fileInput.files[0]);
        }
    });

    async function uploadFile(file: File) {
        const CHUNK_SIZE = 128 * 1024; // 128KB chunks (optimized for slow network)
        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
        const uniqueFilename = `${Date.now()}-${file.name}`; // Unique name for temp file

        uploadStatus.className = "upload-status uploading";

        try {
            for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
                const start = chunkIndex * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, file.size);
                const chunk = file.slice(start, end);

                const formData = new FormData();
                // CRITICAL: Append fields BEFORE file so Busboy receives them first
                formData.append("chunkIndex", chunkIndex.toString());
                formData.append("totalChunks", totalChunks.toString());
                formData.append("filename", uniqueFilename);
                formData.append("file", chunk);

                // Update progress
                const percent = Math.round((chunkIndex / totalChunks) * 100);
                uploadStatus.textContent = `Uploading ${file.name}... ${percent}% (${chunkIndex + 1}/${totalChunks})`;

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 120 second timeout per chunk (2 minutes)

                const response = await fetch("/api/upload", {
                    method: "POST",
                    body: formData,
                    signal: controller.signal,
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || "Upload fehlgeschlagen");
                }

                const result = await response.json();

                if (result.completed) {
                    uploadStatus.className = "upload-status success";
                    uploadStatus.textContent = `‚úì Erfolgreich hochgeladen: ${result.filename}`;
                    fileInput.value = "";
                    loadGallery();
                    return;
                }
            }
        } catch (error) {
            console.error("Upload error:", error);
            uploadStatus.className = "upload-status error";
            uploadStatus.textContent = `‚úó Fehler: ${error instanceof Error ? error.message : "Unbekannter Fehler"}`;
        }
    }

    async function loadGallery() {
        try {
            const response = await fetch("/api/images");
            const images = await response.json();

            if (images.length === 0) {
                gallery.innerHTML =
                    '<div class="loading">Keine Bilder hochgeladen</div>';
                return;
            }

            gallery.innerHTML = images
                .map(
                    (img: any) => `
                <div class="image-card">
                    <img src="${img.url}" alt="${img.name}" class="image-preview" loading="lazy" />
                    <div class="image-info">
                        <p class="image-name">${img.name}</p>
                        <p class="image-meta">Gr√∂√üe: ${formatFileSize(img.size)}</p>
                        <p class="image-meta">Datum: ${new Date(img.date).toLocaleDateString("de-DE")}</p>
                        <div class="image-actions">
                            <button class="btn btn-copy" onclick="copyUrl('${img.url}')">
                                <span class="icon">üìã</span> URL
                            </button>
                            <button class="btn btn-delete" onclick="deleteImage('${img.name}')">
                                <span class="icon">üóëÔ∏è</span> L√∂schen
                            </button>
                        </div>
                    </div>
                </div>
            `,
                )
                .join("");
        } catch (error) {
            gallery.innerHTML =
                '<div class="loading">Fehler beim Laden der Bilder</div>';
            console.error("Error loading gallery:", error);
        }
    }

    function formatFileSize(bytes: number): string {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
        return (bytes / (1024 * 1024)).toFixed(1) + " MB";
    }

    // Global functions for onclick handlers
    (window as any).copyUrl = function (url: string) {
        navigator.clipboard.writeText(url).then(() => {
            alert("Bild-URL kopiert:\n" + url);
        });
    };

    (window as any).deleteImage = async function (filename: string) {
        if (!confirm(`Bild "${filename}" wirklich l√∂schen?`)) return;

        try {
            const response = await fetch(`/api/images/${filename}`, {
                method: "DELETE",
            });

            if (response.ok) {
                alert("Bild gel√∂scht");
                loadGallery();
            } else {
                alert("Fehler beim L√∂schen");
            }
        } catch (error) {
            alert("Fehler beim L√∂schen: " + error);
        }
    };

    // Load gallery on page load
    loadGallery();
</script>
